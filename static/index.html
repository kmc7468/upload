<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Minchan's Upload</title>
    </head>
    <body>
        <div>
            <h1>Minchan's Upload</h1>
            <p>
                GitHub: <a href="https://github.com/kmc7468/upload">https://github.com/kmc7468/upload</a><br>
                Contact: <a href="mailto:me@minchan.me">me@minchan.me</a>
            </p>
        </div>
        <div>
            <h2>Notes</h2>
            <p>You can upload a file up to <strong>1 GiB</strong> in size. The uploaded file is valid for <strong>1 hour.</strong> Uploading will start <strong>immediately</strong> whenever you select a file.</p>
            <p>You may use <code>curl</code> command to upload like this: <code>curl --upload-file your_file https://upload.minchan.me</code></p>
        </div>
        <div>
            <h2>Upload</h2>
            <input type="file" id="fileInput" />
            <p><a id="status" style="display: none;"></a><strong><a id="url" style="display: none;"></a></strong></p>
        </div>

        <script>
            document.getElementById("fileInput").addEventListener("change", function() {
                var file = this.files[0];
                if (!file) return;

                if (file.size > 1073741824) {
                    alert("The file is too large.");
                    return;
                }

                uploadFile(file);
            });

            function uploadFile(file) {
                var filename = encodeURI(file.name);

                var xhr = new XMLHttpRequest();
                xhr.open("PUT", `https://upload.minchan.me/${filename}`, true);
                xhr.setRequestHeader("Content-Type", "application/octet-stream");

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        showDownloadUrl(xhr.responseText.substring(0, xhr.responseText.length - 1));
                    } else {
                        showErrorMessage();
                    }
                };
                xhr.onerror = function() {
                    showErrorMessage();
                };

                showUploadingMessage();
                xhr.send(file);
            }

            function showUploadingMessage() {
                var fileInput = document.getElementById("fileInput");
                fileInput.disabled = true;

                var status = document.getElementById("status");
                status.textContent = "Uploading the file...";
                status.style.display = "inline";

                var url = document.getElementById("url");
                url.style.display = "none";
            }

            function showDownloadUrl(downloadUrl) {
                var fileInput = document.getElementById("fileInput");
                fileInput.disabled = false;

                var status = document.getElementById("status");
                status.textContent = "Download URL: ";
                status.style.display = "inline";

                var url = document.getElementById("url");
                url.textContent = downloadUrl;
                url.href = downloadUrl;
                url.style.display = "inline";

                alert("The file has been uploaded successfully.");
            }

            function showErrorMessage() {
                var fileInput = document.getElementById("fileInput");
                fileInput.disabled = false;

                var status = document.getElementById("status");
                status.textContent = "Failed to upload the file!";
                status.style.display = "inline";

                var url = document.getElementById("url");
                url.style.display = "none";

                alert("An error occurred while uploading the file.");
            }
        </script>
    </body>
</html>